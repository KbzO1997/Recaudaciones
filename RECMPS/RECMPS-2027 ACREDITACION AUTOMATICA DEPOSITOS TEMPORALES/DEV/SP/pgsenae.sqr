!************************************************************************!
!*      Archivo:                pgsenae.sqr                           *!
!*      Base de datos:          cob_pagos                               *!
!*      Producto:               Cuentas Corrientes                      *!
!*      Disenado por:           SANDRA MERINO                           *! 
!*      Fecha de escritura:     12/JUNIO/2012                           *!
!************************************************************************!
!*                              IMPORTANTE                              *!
!*      Este programa es parte de los paquetes bancarios propiedad de   *!
!*      "BANCO BOLIVARIANO"                                             *!
!*      Su uso no autorizado queda expresamente prohibido asi como      *!
!*      cualquier alteracion o agregado hecho por alguno de sus         *!
!*      usuarios sin el debido consentimiento por escrito de la         *!
!*      Presidencia Ejecutiva de BANCO BOLIVARIANO.                     *!
!************************************************************************!
!*                              PROPOSITO                               *!
!*      Este programa Genera el Archivo de Pagos Exitosos para SENAE    *!
!************************************************************************!
!*                              MODIFICACIONES                          *!
!*      FECHA           AUTOR             RAZON                         *!
!*   1  12/JUn/2012   Sandra Merino.   Emision Inicial  SENAE 314-CU-1890*!
!************************************************************************!


#include  "definic.inc"
#define TAB             9                     !Codigo ascii del tab
#define ANCHO_PAG       500                   !Ancho de la hoja
#define FOR_FECHA_AMD   YYYYMMDD              !Formato de la fecha
#define FOR_DIN_12      999,999,999,999.99    !Formato para Monto
#define LARGO_PAG       9000

#define  WPATH      '/respaldo/archivos/cuentas/data/'



Begin-Setup
  use cob_pagos
  page-size {LARGO_PAG} {ANCHO_PAG}   !Determinar largo y ancho de pagina
  no-formfeed 
End-Setup


#include "log.inc"
#include "ctacte.inc"


!------------
Begin-Program
!------------
  do Inicializar_Programa
  do ParamS (1,$i_fecha_proceso,'','','')
  do ParamS (2,$i_password,'','','')
  
  do Main
  do Finalizar_Programa
End-Program

!-------------------
Begin-Procedure Main
!-------------------
do Genera_Archivo
End-Procedure

!-----------------------------
Begin-Procedure Genera_Archivo
!-----------------------------
execute on-error=Error  cob_pagos..sp_genera_archivo_senae
    @i_fecha_proceso = $i_fecha_proceso
    @i_opcion        = 0

do SetParametros
do FormarArchivo
End-Procedure

Begin-Procedure Error
   show 'NO HAY REGISTROS PARA GENERAR EL ARCHIVO'
   do Abortar
End-Procedure

!----------------------------
begin-procedure SetParametros
!----------------------------

let $dia = substr($i_fecha_proceso,4,2)
let $mes = substr($i_fecha_proceso,1,2)
let $anio = substr($i_fecha_proceso,9,2) 

let $name_file = 'C02DDCBOL' || $anio || $mes || $dia ||'.txt'
let $i_archivo = {WPATH}  || $name_file
new-report $i_archivo
end-procedure



!----------------------------
begin-procedure FormarArchivo
!----------------------------
show 'GENERADO ARCHIVO DE SENAE ........'

Begin-Select
top 1 gc_trama_senae &w_cabecerera
  let $linea = &w_cabecerera 
  print $linea (0)
from cob_pagos..pg_genera_archivo_senae
End-Select 


Begin-Select
gc_trama_senae     &w_detalle1
gc_trama_senae2    &w_detalle2
  next-listing
  let $detalle1 = &w_detalle1
  let $detalle2 = &w_detalle2
  
    let $tab = chr(9)
       let $linea = $detalle1 || $detalle2 
       
     print $linea (0,1,300)

from cob_pagos..pg_genera_archivo_senae
where substring(gc_trama_senae,1,2) ='DR'
End-Select

!let $w_bcp = 'bcp cob_pagos..pg_genera_archivo_senae out ' || $i_archivo || ' -b1000 -c -U' || $username || ' -P' || $i_password  || ' -t"" '
!let $w_bcp = 'bcp cob_pagos..pg_genera_archivo_senae out ' || $i_archivo || ' -b1000 -c -U' || $username || ' -P' || $i_password   
!show $w_bcp
!call system using $w_bcp #retorno
!if #retorno <> 0
   ! let $w_mensaje = 'Falla al ejecutar comando bcp'

    !show 'ERROR: ' $w_mensaje
    !do Abortar
!end-if
show 'ARCHIVO DE SENAE GENERADO OK'
show 'RUTA ARCHIVO: ' $i_archivo
end-procedure

